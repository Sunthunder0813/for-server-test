<!DOCTYPE html>
<html>
<head>
    <title>YOLO Tracking Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f8f8; color: #f8f9fa; }
        .video-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start; min-height: 60vh; overflow-x: auto; width: 100%; box-sizing: border-box; gap: 1.5rem; }
        .camera-frame-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 700px; min-width: 250px; flex: 1 1 350px; overflow: hidden; }
        .video-frame-container { position: relative; width: 100%; display: flex; align-items: center; justify-content: center; }
        .video-frame { border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.5); border: 2px solid #343a40; width: 100%; height: auto; aspect-ratio: 16/9; background: #000; object-fit: contain; display: block; max-width: 100%; }
        .camera-label { color: #222; font-weight: bold; margin: 0.5rem 0 0.2rem 0; font-size: 1.1rem; text-align: center; }
        .reconnecting-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; z-index: 10; background: rgba(30,30,30,0.45); backdrop-filter: blur(6px); pointer-events: none; transition: opacity 0.3s; opacity: 0; }
        .reconnecting-overlay.active { opacity: 1; pointer-events: auto; }
        .reconnecting-spinner { display: flex; flex-direction: column; align-items: center; }
        .reconnecting-spinner .spinner-border { width: 3rem; height: 3rem; color: #ff9800; }
        .reconnecting-spinner span { margin-top: 1rem; color: #fff; font-size: 1.3rem; font-weight: bold; text-shadow: 0 2px 8px #000; letter-spacing: 1px; animation: pulse 1.2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @media (max-width: 900px) { .video-container { flex-direction: column; gap: 1.5rem; } .camera-frame-wrapper { max-width: 98vw; } .video-frame { width: 100% !important; height: auto !important; } }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center text-dark my-4" style="font-weight: bold;">Illegal Parking Detection - Live</h1>

    <div class="video-container" id="videoContainer">
        <div class="camera-frame-wrapper">
            <span class="camera-label">CCTV 1</span>
            <div class="video-frame-container">
                <img src="" class="video-frame" alt="CCTV 1 Feed" id="liveVideoC1">
                <div class="reconnecting-overlay" id="reconnectingOverlayC1">
                    <div class="reconnecting-spinner">
                        <div class="spinner-border" role="status"></div>
                        <span>Reconnecting...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="camera-frame-wrapper">
            <span class="camera-label">CCTV 2</span>
            <div class="video-frame-container">
                <img src="" class="video-frame" alt="CCTV 2 Feed" id="liveVideoC2">
                <div class="reconnecting-overlay" id="reconnectingOverlayC2">
                    <div class="reconnecting-spinner">
                        <div class="spinner-border" role="status"></div>
                        <span>Reconnecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="violationEvents" class="mt-4"></div>
</div>

<div id="serverStatusBanner" class="alert text-center" style="display:none;position:fixed;top:0;left:0;width:100%;z-index:9999;font-weight:bold;">
    <span id="serverStatusIcon"></span>
    <span id="serverStatusText"></span>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let RASPI_BASE = "";

function raspiUrl(path){ return `${RASPI_BASE}${path}`; }

function setRaspiBase(url) {
    if (url && url.trim() !== "") {
        RASPI_BASE = url;
        console.log("Using Pi public URL for feeds:", RASPI_BASE);
    } else {
        RASPI_BASE = window.location.origin;
        console.log("Using Railway origin for feeds:", RASPI_BASE);
    }
}

function fetchRaspiBaseAndInit() {
    fetch('/api/get_pi_url')
        .then(r => r.json())
        .then(data => {
            setRaspiBase(data.public_url);
            startApp();
        })
        .catch(() => {
            setRaspiBase("");
            startApp();
        });
}

function startApp() {
    reloadVideo(liveVideoC1, overlayC1, "/video_feed_c1");
    reloadVideo(liveVideoC2, overlayC2, "/video_feed_c2");
    setInterval(checkCameraStatus, 5000);
    setInterval(checkServerHealth, 10000);
    loadViolationEvents();
    setInterval(loadViolationEvents, 10000);
}

const liveVideoC1 = document.getElementById('liveVideoC1');
const liveVideoC2 = document.getElementById('liveVideoC2');
const overlayC1 = document.getElementById('reconnectingOverlayC1');
const overlayC2 = document.getElementById('reconnectingOverlayC2');

function reloadVideo(imgElement, overlay, feedPath){
    let retry = 0;
    function tryLoad(){
        const ts = Date.now();
        imgElement.src = raspiUrl(feedPath) + "?t=" + ts;
        overlay.classList.add('active');

        imgElement.onerror = () => {
            retry++;
            setTimeout(tryLoad, Math.min(500*(retry**1.5), 5000));
        };
        imgElement.onload = () => {
            overlay.classList.remove('active');
            retry = 0;
            setTimeout(tryLoad, 15000); // reload every 15s
        };
    }
    tryLoad();
}

function checkCameraStatus() {
    fetch(raspiUrl('/api/camera_status')).then(r=>r.json()).then(status=>{
        overlayC1.classList.toggle('active', !status.Camera_1.online);
        overlayC2.classList.toggle('active', !status.Camera_2.online);
    }).catch(()=>{
        overlayC1.classList.add('active');
        overlayC2.classList.add('active');
    });
}

function checkServerHealth() {
    const banner = document.getElementById('serverStatusBanner');
    const icon = document.getElementById('serverStatusIcon');
    const text = document.getElementById('serverStatusText');
    fetch(raspiUrl('/ping'), {cache: "no-store"}).then(res=>{
        if(res.ok){
            banner.classList.remove('alert-danger'); banner.classList.add('alert-success');
            icon.innerHTML='<i class="bi bi-check-circle-fill"></i>';
            text.textContent=' Connected to Raspberry Pi Server';
            banner.style.display='';
        } else throw new Error();
    }).catch(()=>{
        banner.classList.remove('alert-success'); banner.classList.add('alert-danger');
        icon.innerHTML='<i class="bi bi-exclamation-triangle-fill"></i>';
        text.textContent=' Server Offline: Unable to connect';
        banner.style.display='';
    });
}

async function loadViolationEvents(){
    try{
        const res=await fetch('/api/events'); const events=await res.json();
        const container=document.getElementById('violationEvents');
        if(!events.length){ container.innerHTML="<div class='alert alert-info'>No violations detected yet.</div>"; return; }
        container.innerHTML=events.map(ev=>`
            <div class="card mb-3">
                <div class="row g-0">
                    <div class="col-md-4"><img src="${ev.image_url}" class="img-fluid rounded-start" alt="Violation"></div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h5 class="card-title">${ev.camera_id}</h5>
                            <p class="card-text"><small class="text-muted">${ev.timestamp}</small></p>
                            <pre style="font-size:0.9em;">${JSON.stringify(ev.meta,null,2)}</pre>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }catch{ document.getElementById('violationEvents').innerHTML="<div class='alert alert-danger'>Failed to load events.</div>"; }
}

window.onload = fetchRaspiBaseAndInit;
</script>
</body>
</html>
